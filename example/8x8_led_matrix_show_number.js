/**
 * Linkit 7688 範例
 * 使用 GPIO 控制 8x8 LED Matrix (共陽) 
 * 顯示數字
 * 
 * @author Abola Lee 
 * @version 1.0
 * @since 2016-01-10
 * 
 * @link http://www.gibar.co/2016/01/7688-8x8-led-matrix.html
 */
var mraa = require('mraa');

// 腳位命名參考
//  
//    
//    \Col 1   2   3   4   5   6   7   8
//Row  \ _13__03__04__10__06__11__15__16_  (針腳)
// 1  09|                               |
// 2  14|                               |
// 3  08|                               |
// 4  12|              8x8              |
// 5  01|           LED Matrix          |
// 6  07|                               |
// 7  02|                               |
// 8  05|_______________________________|
//   (針腳)


// 設定GPIO 接腳
var col = [
      new mraa.Gpio(2)
      , new mraa.Gpio(16)
      , new mraa.Gpio(17)
      , new mraa.Gpio(44)
      , new mraa.Gpio(5)
      , new mraa.Gpio(46)
      , new mraa.Gpio(0)
      , new mraa.Gpio(1) 
    ],
    row = [
      new mraa.Gpio(37)
      , new mraa.Gpio(3)
      , new mraa.Gpio(13)
      , new mraa.Gpio(45)
      , new mraa.Gpio(14)
      , new mraa.Gpio(12)
      , new mraa.Gpio(15)
      , new mraa.Gpio(4)      
    ];
    
var hz
    
// 預設全亮測試
for(var idx=0; idx<8; idx++) col[idx].dir(mraa.DIR_OUT_HIGH);
for(var idx=0; idx<8; idx++) row[idx].dir(mraa.DIR_OUT_LOW);

sleep(1000);
reset();

// 字集設定 

var textTable = [
[0x7F,0x88,0x88,0x88,0x7F,0x00,0x00,0x00],
[0xFF,0x91,0x91,0x91,0x6E,0x00,0x00,0x00],
[0x7E,0x81,0x81,0x81,0x42,0x00,0x00,0x00],
[0xFF,0x81,0x81,0x42,0x3C,0x00,0x00,0x00],
[0xFF,0x91,0x91,0x91,0x81,0x00,0x00,0x00],
[0xFF,0x90,0x90,0x90,0x80,0x00,0x00,0x00],
[0x7E,0x81,0x89,0x89,0x4E,0x00,0x00,0x00],
[0xFF,0x10,0x10,0x10,0xFF,0x00,0x00,0x00],
[0x81,0x81,0xFF,0x81,0x81,0x00,0x00,0x00],
[0x06,0x01,0x01,0x01,0xFE,0x00,0x00,0x00],
[0xFF,0x18,0x24,0x42,0x81,0x00,0x00,0x00],
[0xFF,0x01,0x01,0x01,0x01,0x00,0x00,0x00],
[0xFF,0x40,0x30,0x40,0xFF,0x00,0x00,0x00],
[0xFF,0x40,0x30,0x08,0xFF,0x00,0x00,0x00],
[0x7E,0x81,0x81,0x81,0x7E,0x00,0x00,0x00],
[0xFF,0x88,0x88,0x88,0x70,0x00,0x00,0x00],
[0x7E,0x81,0x85,0x82,0x7D,0x00,0x00,0x00],
[0xFF,0x88,0x8C,0x8A,0x71,0x00,0x00,0x00],
[0x61,0x91,0x91,0x91,0x8E,0x00,0x00,0x00],
[0x80,0x80,0xFF,0x80,0x80,0x00,0x00,0x00],
[0xFE,0x01,0x01,0x01,0xFE,0x00,0x00,0x00],
[0xF0,0x0C,0x03,0x0C,0xF0,0x00,0x00,0x00],
[0xFF,0x02,0x0C,0x02,0xFF,0x00,0x00,0x00],
[0xC3,0x24,0x18,0x24,0xC3,0x00,0x00,0x00],
[0xE0,0x10,0x0F,0x10,0xE0,0x00,0x00,0x00],
[0x83,0x85,0x99,0xA1,0xC1,0x00,0x00,0x00],
[0x06,0x29,0x29,0x29,0x1F,0x00,0x00,0x00],
[0xFF,0x09,0x11,0x11,0x0E,0x00,0x00,0x00],
[0x1E,0x21,0x21,0x21,0x12,0x00,0x00,0x00],
[0x0E,0x11,0x11,0x09,0xFF,0x00,0x00,0x00],
[0x0E,0x15,0x15,0x15,0x0C,0x00,0x00,0x00],
[0x08,0x7F,0x88,0x80,0x40,0x00,0x00,0x00],
[0x30,0x49,0x49,0x49,0x7E,0x00,0x00,0x00],
[0xFF,0x08,0x10,0x10,0x0F,0x00,0x00,0x00],
[0x00,0x00,0x5F,0x00,0x00,0x00,0x00,0x00],
[0x02,0x01,0x21,0xBE,0x00,0x00,0x00,0x00],
[0xFF,0x04,0x0A,0x11,0x00,0x00,0x00,0x00],
[0x00,0x81,0xFF,0x01,0x00,0x00,0x00,0x00],
[0x3F,0x20,0x18,0x20,0x1F,0x00,0x00,0x00],
[0x3F,0x10,0x20,0x20,0x1F,0x00,0x00,0x00],
[0x0E,0x11,0x11,0x11,0x0E,0x00,0x00,0x00],
[0x3F,0x24,0x24,0x24,0x18,0x00,0x00,0x00],
[0x10,0x28,0x28,0x18,0x3F,0x00,0x00,0x00],
[0x1F,0x08,0x10,0x10,0x08,0x00,0x00,0x00],
[0x09,0x15,0x15,0x15,0x02,0x00,0x00,0x00],
[0x20,0xFE,0x21,0x01,0x02,0x00,0x00,0x00],
[0x1E,0x01,0x01,0x02,0x1F,0x00,0x00,0x00],
[0x1C,0x02,0x01,0x02,0x1C,0x00,0x00,0x00],
[0x1E,0x01,0x0E,0x01,0x1E,0x00,0x00,0x00],
[0x11,0x0A,0x04,0x0A,0x11,0x00,0x00,0x00],
[0x00,0x39,0x05,0x05,0x3E,0x00,0x00,0x00],
[0x11,0x13,0x15,0x19,0x11,0x00,0x00,0x00],
[0x00,0x41,0xFF,0x01,0x00,0x00,0x00,0x00],
[0x43,0x85,0x89,0x91,0x61,0x00,0x00,0x00],
[0x42,0x81,0x91,0x91,0x6E,0x00,0x00,0x00],
[0x18,0x28,0x48,0xFF,0x08,0x00,0x00,0x00],
[0xF2,0x91,0x91,0x91,0x8E,0x00,0x00,0x00],
[0x1E,0x29,0x49,0x89,0x86,0x00,0x00,0x00],
[0x80,0x8F,0x90,0xA0,0xC0,0x00,0x00,0x00],
[0x6E,0x91,0x91,0x91,0x6E,0x00,0x00,0x00],
[0x70,0x89,0x89,0x8A,0x7C,0x00,0x00,0x00],
[0x60,0x80,0x8D,0x90,0x60,0x00,0x00,0x00],
[0x00,0x00,0xFD,0x00,0x00,0x00,0x00,0x00],
[0x7E,0x89,0x91,0xA1,0x7E,0x00,0x00,0x00],
[0x66,0x89,0x8F,0x81,0x7E,0x00,0x00,0x00],
[0x24,0xFF,0x24,0xFF,0x24,0x00,0x00,0x00],
[0x76,0x89,0x95,0x62,0x05,0x00,0x00,0x00],
[0x00,0x3C,0x42,0x81,0x00,0x00,0x00,0x00],
[0x00,0x81,0x42,0x3C,0x00,0x00,0x00,0x00],
[0x08,0x08,0x3E,0x08,0x08,0x00,0x00,0x00],
[0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00],
[0x14,0x14,0x14,0x14,0x14,0x00,0x00,0x00],
[0x10,0x10,0x54,0x38,0x10,0x00,0x00,0x00],
[0x08,0x1C,0x2A,0x08,0x08,0x00,0x00,0x00],
[0x12,0x2A,0x7F,0x2A,0x24,0x00,0x00,0x00],
[0x44,0x02,0x12,0x02,0x44,0x00,0x00,0x00],
[0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00],
[0x08,0x04,0x02,0x01,0x01,0x01,0x01,0x01],
[0x10,0x20,0x40,0x80,0x80,0x02,0x02,0x02],
[0x99,0x24,0x42,0x99,0x99,0x42,0x24,0x99],
[0xFF,0x81,0xBD,0xA5,0xA5,0xBD,0x81,0xFF],
[0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,0xAA],
[0x33,0x33,0xCC,0xCC,0x33,0x33,0xCC,0xCC],
[0x42,0xC3,0x24,0x18,0x18,0x24,0xC3,0x42],
[0xFD,0x85,0xB5,0xA5,0xA5,0xBD,0x81,0xFF],
[0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF],
[0xFF,0x7E,0x7E,0x7E,0x7E,0x42,0x24,0x18],
[0x18,0x18,0x3C,0x66,0x66,0x3C,0x18,0x18],
[0x78,0x78,0x18,0xFF,0xFF,0x0C,0x3C,0x3C],
[0xF2,0x82,0x12,0x3A,0x10,0xC0,0xC4,0x0E],
[0x7F,0x84,0xA7,0x84,0xA7,0x84,0x7F,0x00],
[0x3C,0x42,0x81,0xA1,0x89,0x95,0xA5,0x42],
[0x07,0x2F,0x1C,0x3E,0x3C,0x30,0x30,0x30],
[0x5A,0x99,0x00,0x18,0x18,0x00,0x18,0x18],
[0x82,0x41,0x82,0x41,0x82,0x41,0x82,0x41],
[0x00,0x01,0x06,0x7E,0xDF,0x7E,0x06,0x01],
[0x04,0x0F,0x1F,0x3C,0x3C,0x1F,0x0F,0x04],
[0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00],
[0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55],
[0x49,0x92,0x24,0x49,0x92,0x24,0x49,0x92],
[0x92,0x49,0x24,0x92,0x49,0x24,0x92,0x49],
[0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18],
[0x18,0x18,0x3C,0x5A,0x99,0x3C,0x42,0x81],
[0x18,0x3C,0x7E,0xFF,0x18,0x18,0x18,0x18],
[0x81,0x42,0x24,0x18,0x81,0x42,0x24,0x18],
[0x18,0x24,0x42,0x81,0x18,0x24,0x42,0x81],
[0x81,0x42,0x24,0x99,0x5A,0x3C,0x18,0x18],
[0x18,0x18,0x18,0x18,0xFF,0x7E,0x3C,0x18]];

var columnMask = [0x80,0x40,0x20,0x10,0x08,0x04,0x02,0x01];

var fontInterval;

function showFont(font){
  // 清除前一個字的撥放
  clearInterval(fontInterval);
  reset();
  
  fontInterval = setInterval( function(){
    var r=0;
    while(1){
      // 回到 Row1 重新開始
      if (r>=8) r=0;
        
      // 熄燈
      reset();
      
      // 啟用目前指定的 Row
      row[r].write(0);
      // 啟用指定的 Column
      for(var c=0; c<8; c++) {
        col[c].write( (columnMask[c]&font[c]>0)?1:0  );
      }
      ++r;
      sleep(2);
    }
  }, 0 );

}

/**
 * 回復全暗
 */
function reset(){
  for(var idx=0; idx<8; idx++) col[idx].write(0);
  for(var idx=0; idx<8; idx++) row[idx].write(1);
}

/**
 * Simple sleep function 
 * 
 * @link http://www.sitepoint.com/delay-sleep-pause-wait/
 */
function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
}

var tableIndex=0;
// show time !!
var showTextTable = setInterval(function(){
  if ( tableIndex >= textTable.length ) {
    // end 
    reset();
    clearInterval(showTextTable);
  }
  else {
    showFont(textTable[tableIndex++]);
  }
},500);

